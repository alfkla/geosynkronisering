# Starter pipeline
# Start with a minimal pipeline that you can customize to build and deploy your code.
# Add steps that build, run tests, deploy, and more:
# https://aka.ms/yaml

trigger: none

parameters:
  - name: ServiceConnection_name
    type: string 
    default: dvh-geosynk-nk-test
  
variables:
  ServiceConnection: ${{parameters.ServiceConnection_name}}

pool:
  vmImage: ubuntu-latest

steps:

- task: AzureCLI@2
  displayName: Azure CLI
  inputs:
    azureSubscription: $(ServiceConnection)
    scriptType: 'bash'
    scriptLocation: 'inlineScript'
    inlineScript: |
      az account set -s nk-test -o table
      az group create -n $(ServiceConnection) -o table
      az account show
      az vm create -n qmstestvm -g $(ServiceConnection) --image Win2019Datacenter --public-ip-address-dns-name geosynk-test --admin-username sjef --admin-password qMSttyhacSpvU7 --size Standard_D4_v3 -o table
      az postgres flexible-server create --location westeurope -g $(ServiceConnection) -n geosynk-test --admin-user postgres --admin-password JrgGTduKT-oq --sku-name Standard_D2s_v3 --tier GeneralPurpose --public-access 0.0.0.0 --storage-size 128 --version 11
      az vm run-command invoke  --command-id RunPowerShellScript --name qmstestvm -g dvh-geosynk-nk-test --scripts "c:\ProgramData\chocolatey\bin\choco install -y vcredist2017"
      az vm run-command invoke  --command-id RunPowerShellScript --name qmstestvm -g dvh-geosynk-nk-test --scripts "c:\ProgramData\chocolatey\bin\choco install -y psqlodbc"
      az vm run-command invoke  --command-id RunPowerShellScript --name qmstestvm -g dvh-geosynk-nk-test --scripts @odbcdriver.ps1
